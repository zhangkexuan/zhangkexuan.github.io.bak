<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="StampedLock类，在JDK1.8时引入，是对读写锁ReentrantReadWriteLock的增强，该类提供了一些功能，优化了读锁、写锁的访问，同时使读写锁之间可以互相转换，更细粒度控制并发。 首先明确下，该类的设计初衷是作为一个内部工具类，用于辅助开发其它线程安全组件，用得好，该类可以提升系统性能，用不好，容易产生死锁和其它莫名其妙的问题。">
<meta property="og:type" content="article">
<meta property="og:title" content="juc_locks框架#7-AQS_StampedLock">
<meta property="og:url" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/index.html">
<meta property="og:site_name" content="摘星">
<meta property="og:description" content="StampedLock类，在JDK1.8时引入，是对读写锁ReentrantReadWriteLock的增强，该类提供了一些功能，优化了读锁、写锁的访问，同时使读写锁之间可以互相转换，更细粒度控制并发。 首先明确下，该类的设计初衷是作为一个内部工具类，用于辅助开发其它线程安全组件，用得好，该类可以提升系统性能，用不好，容易产生死锁和其它莫名其妙的问题。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922122950917.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123034223.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123047041.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123208729.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123302778.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123657800.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922123804156.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922131825419.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922131854468.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922131908193.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922131952653.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132004020.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132015033.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132025687.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132039412.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132052263.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/(image-20200922135649764.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132106088.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132118728.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922132136022.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922133037585.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922133235161.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922133701747.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922133730463.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135143639.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135154316.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135208152.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135218433.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135233190.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135245323.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135257395.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135310849.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135328579.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135340146.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135349722.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135406780.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135420734.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135440824.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135450981.png">
<meta property="og:image" content="c:%5CUsers%5C65135%5CDesktop%5Cblog%E6%96%87%E7%AB%A0%5C%E6%B7%B1%E5%85%A5%E5%B9%B6%E5%8F%91%5Cjuc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock(image-20200922135459409.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135631763.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135522882.png">
<meta property="og:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922135547455.png">
<meta property="article:published_time" content="2020-08-19T01:34:33.000Z">
<meta property="article:modified_time" content="2020-08-19T01:34:33.000Z">
<meta property="article:author" content="摘星">
<meta property="article:tag" content="锁">
<meta property="article:tag" content="深入并发">
<meta property="article:tag" content="juc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/image-20200922122950917.png">

<link rel="canonical" href="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>juc_locks框架#7-AQS_StampedLock | 摘星</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">摘星</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/old/juc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="摘星">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="摘星">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          juc_locks框架#7-AQS_StampedLock
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-19 09:34:33" itemprop="dateCreated datePublished" datetime="2020-08-19T09:34:33+08:00">2020-08-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">深入并发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>StampedLock类，在JDK1.8时引入，是对读写锁ReentrantReadWriteLock的增强，该类提供了一些功能，优化了读锁、写锁的访问，同时使读写锁之间可以互相转换，更细粒度控制并发。</p>
<p>首先明确下，该类的设计初衷是作为一个内部工具类，用于辅助开发其它线程安全组件，用得好，该类可以提升系统性能，用不好，容易产生死锁和其它莫名其妙的问题。</p>
<a id="more"></a>

<h1 id="一、StampedLock类简介"><a href="#一、StampedLock类简介" class="headerlink" title="一、StampedLock类简介"></a>一、StampedLock类简介</h1><h2 id="1-1-StampedLock的引入"><a href="#1-1-StampedLock的引入" class="headerlink" title="1.1 StampedLock的引入"></a>1.1 StampedLock的引入</h2><blockquote>
<p>先来看下，为什么有了ReentrantReadWriteLock，还要引入StampedLock？</p>
</blockquote>
<p>ReentrantReadWriteLock使得多个读线程同时持有读锁（只要写锁未被占用），而写锁是独占的。</p>
<p>但是，读写锁如果使用不当，很容易产生“饥饿”问题：</p>
<p>比如在读线程非常多，写线程很少的情况下，很容易导致写线程“饥饿”，虽然使用“公平”策略可以一定程度上缓解这个问题，但是“公平”策略是以牺牲系统吞吐量为代价的。</p>
<h2 id="1-2-StampedLock的特点"><a href="#1-2-StampedLock的特点" class="headerlink" title="1.2 StampedLock的特点"></a>1.2 StampedLock的特点</h2><p>StampedLock的主要特点概括一下，有以下几点：</p>
<ol>
<li>所有获取锁的方法，都返回一个邮戳（Stamp），Stamp为0表示获取失败，其余都表示成功；</li>
<li>所有释放锁的方法，都需要一个邮戳（Stamp），这个Stamp必须是和成功获取锁时得到的Stamp一致；</li>
<li>StampedLock是不可重入的；（如果一个线程已经持有了写锁，再去获取写锁的话就会造成死锁）</li>
<li>StampedLock有三种访问模式：<br>①Reading（读模式）：功能和ReentrantReadWriteLock的读锁类似<br>②Writing（写模式）：功能和ReentrantReadWriteLock的写锁类似<br>③Optimistic reading（乐观读模式）：这是一种优化的读模式。</li>
<li>StampedLock支持读锁和写锁的相互转换<br>我们知道RRW中，当线程获取到写锁后，可以降级为读锁，但是读锁是不能直接升级为写锁的。<br>StampedLock提供了读锁和写锁相互转换的功能，使得该类支持更多的应用场景。</li>
<li>无论写锁还是读锁，都不支持Conditon等待</li>
</ol>
<blockquote>
<p>我们知道，在ReentrantReadWriteLock中，当读锁被使用时，如果有线程尝试获取写锁，该写线程会阻塞。<br>但是，在Optimistic reading中，即使读线程获取到了读锁，写线程尝试获取写锁也不会阻塞，这相当于对读模式的优化，但是可能会导致数据不一致的问题。所以，当使用Optimistic reading获取到读锁时，必须对获取结果进行校验。</p>
</blockquote>
<h1 id="二、StampedLock使用示例"><a href="#二、StampedLock使用示例" class="headerlink" title="二、StampedLock使用示例"></a>二、StampedLock使用示例</h1><p>先来看一个Oracle官方的例子：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> StampedLock sl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">double</span> deltaX<span class="token punctuation">,</span> <span class="token keyword">double</span> deltaY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//涉及对共享资源的修改，使用写锁-独占操作</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            x <span class="token operator">+=</span> deltaX<span class="token punctuation">;</span>
            y <span class="token operator">+=</span> deltaY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            sl<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 使用乐观读锁访问共享资源
     * 注意：乐观读锁在保证数据一致性上需要拷贝一份要操作的变量到方法栈，并且在操作数据时候可能其他写线程已经修改了数据，
     * 而我们操作的是方法栈里面的数据，也就是一个快照，所以最多返回的不是最新的数据，但是一致性还是得到保障的。
     *
     * @return
     */</span>
    <span class="token keyword">double</span> <span class="token function">distanceFromOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用乐观读锁</span>
        <span class="token keyword">double</span> currentX <span class="token operator">=</span> x<span class="token punctuation">,</span> currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 拷贝共享资源到本地方法栈中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// 如果有写锁被占用，可能造成数据不一致，所以要切换到普通读锁模式</span>
            stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                currentX <span class="token operator">=</span> x<span class="token punctuation">;</span>
                currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>currentX <span class="token operator">*</span> currentX <span class="token operator">+</span> currentY <span class="token operator">*</span> currentY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">moveIfAtOrigin</span><span class="token punctuation">(</span><span class="token keyword">double</span> newX<span class="token punctuation">,</span> <span class="token keyword">double</span> newY<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// upgrade</span>
        <span class="token comment" spellcheck="true">// Could instead start with optimistic, not read mode</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> ws <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryConvertToWriteLock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//读锁转换为写锁</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">!=</span> 0L<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stamp <span class="token operator">=</span> ws<span class="token punctuation">;</span>
                    x <span class="token operator">=</span> newX<span class="token punctuation">;</span>
                    y <span class="token operator">=</span> newY<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            sl<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，上述示例最特殊的其实是<strong>distanceFromOrigin</strong>方法，这个方法中使用了“Optimistic reading”乐观读锁，使得读写可以并发执行，但是“Optimistic reading”的使用必须遵循以下模式：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 非阻塞获取版本信息</span>
copyVaraibale to <span class="token function">ThreadMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 拷贝变量到线程本地堆栈</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// 校验</span>
    <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 获取读锁</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">copyVaraibale2ThreadMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 拷贝变量到线程本地堆栈</span>
     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// 释放悲观锁</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token function">useThreadMemoryVarables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// 使用线程本地堆栈里面的数据进行操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="三、StampedLock原理"><a href="#三、StampedLock原理" class="headerlink" title="三、StampedLock原理"></a>三、StampedLock原理</h1><h2 id="3-1-StampedLock的内部常量"><a href="#3-1-StampedLock的内部常量" class="headerlink" title="3.1 StampedLock的内部常量"></a>3.1 StampedLock的内部常量</h2><p>StampedLock虽然不像其它锁一样定义了内部类来实现AQS框架，但是StampedLock的基本实现思路还是利用CLH队列进行线程的管理，通过同步状态值来表示锁的状态和类型。</p>
<p>StampedLock内部定义了很多常量，定义这些常量的根本目的还是和ReentrantReadWriteLock一样，对同步状态值按位切分，以通过位运算对State进行操作：</p>
<blockquote>
<p>对于StampedLock来说，写锁被占用的标志是第8位为1，读锁使用0-7位，正常情况下读锁数目为1-126，超过126时，使用一个名为<code>readerOverflow</code>的int整型保存超出数。</p>
</blockquote>
<p><img src="image-20200922122950917.png" alt="(image-20200922122950917"></p>
<p>部分常量的比特位表示如下：<br><img src="image-20200922123034223.png" alt="(image-20200922123034223"></p>
<p>另外，StampedLock相比ReentrantReadWriteLock，对多核CPU进行了优化，可以看到，当CPU核数超过1时，会有一些自旋操作:<br><img src="image-20200922123047041.png" alt="(image-20200922123047041"></p>
<h2 id="3-2-示例分析"><a href="#3-2-示例分析" class="headerlink" title="3.2 示例分析"></a>3.2 示例分析</h2><blockquote>
<p>假设现在有三个线程：ThreadA、ThreadB、ThreadC、ThreadD。操作如下：<br><code>//ThreadA调用writeLock, 获取写锁</code><br><code>//ThreadB调用readLock, 获取读锁</code><br><code>//ThreadC调用readLock, 获取读锁</code><br><code>//ThreadD调用writeLock, 获取写锁</code><br><code>//ThreadE调用readLock, 获取读锁</code></p>
</blockquote>
<h3 id="1-StampedLock对象的创建"><a href="#1-StampedLock对象的创建" class="headerlink" title="1. StampedLock对象的创建"></a>1. StampedLock对象的创建</h3><p>StampedLock的构造器很简单，构造时设置下同步状态值：<br><img src="image-20200922123208729.png" alt="(image-20200922123208729"></p>
<p>另外，StamedLock提供了三类视图：<br><img src="image-20200922123302778.png" alt="(image-20200922123302778"></p>
<p>这些视图其实是对StamedLock方法的封装，便于习惯了ReentrantReadWriteLock的用户使用：例如，<strong>ReadLockView</strong>其实相当于<code>ReentrantReadWriteLock.readLock()</code>返回的读锁;<br><img src="image-20200922123657800.png" alt="(image-20200922123657800"></p>
<h3 id="2-ThreadA调用writeLock获取写锁"><a href="#2-ThreadA调用writeLock获取写锁" class="headerlink" title="2. ThreadA调用writeLock获取写锁"></a>2. ThreadA调用writeLock获取写锁</h3><p>来看下<strong>writeLock</strong>方法：<br><img src="image-20200922123804156.png" alt="(image-20200922123804156"></p>
<p>StampedLock中大量运用了位运算，这里<code>(s = state) &amp; ABITS == 0L</code> 表示读锁和写锁都未被使用，这里写锁可以立即获取成功，然后CAS操作更新同步状态值State。</p>
<p>操作完成后，等待队列的结构如下：<br><img src="image-20200922131825419.png" alt="(image-20200922131825419"></p>
<blockquote>
<p>注意：StampedLock中，等待队列的结点要比AQS中简单些，仅仅三种状态。<br>0：初始状态<br>-1：等待中<br>1：取消</p>
</blockquote>
<p>另外，结点的定义中有个<code>cowait</code>字段，该字段指向一个栈，用于保存读线程，这个后续会讲到。<br><img src="image-20200922131854468.png" alt="(image-20200922131854468"></p>
<h3 id="3-ThreadB调用readLock获取读锁"><a href="#3-ThreadB调用readLock获取读锁" class="headerlink" title="3. ThreadB调用readLock获取读锁"></a>3. ThreadB调用readLock获取读锁</h3><p>来看下<strong>readLock</strong>方法：<br>由于ThreadA此时持有写锁，所以ThreadB获取读锁失败，将调用<strong>acquireRead</strong>方法，加入等待队列：<br><img src="image-20200922131908193.png" alt="(image-20200922131908193"></p>
<p><strong>acquireRead</strong>方法非常复杂，用到了大量自旋操作：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 尝试自旋的获取读锁, 获取不到则加入等待队列, 并阻塞线程
 *
 * @param interruptible true 表示检测中断, 如果线程被中断过, 则最终返回INTERRUPTED
 * @param deadline      如果非0, 则表示限时获取
 * @return 非0表示获取成功, INTERRUPTED表示中途被中断过
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">acquireRead</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    WNode node <span class="token operator">=</span> null<span class="token punctuation">,</span> p<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// node指向入队结点, p指向入队前的队尾结点</span>

    <span class="token comment" spellcheck="true">/**
     * 自旋入队操作
     * 如果写锁未被占用, 则立即尝试获取读锁, 获取成功则返回.
     * 如果写锁被占用, 则将当前读线程包装成结点, 并插入等待队列（如果队尾是写结点,直接链接到队尾;否则,链接到队尾读结点的栈中）
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WNode h<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> wtail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 如果队列为空或只有头结点, 则会立即尝试获取读锁</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">&lt;</span> RFULL <span class="token operator">?</span>     <span class="token comment" spellcheck="true">// 判断写锁是否被占用</span>
                    U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> RUNIT<span class="token punctuation">)</span> <span class="token operator">:</span>  <span class="token comment" spellcheck="true">//写锁未占用,且读锁数量未超限, 则更新同步状态</span>
                    <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> WBIT <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> 0L<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//写锁未占用,但读锁数量超限, 超出部分放到readerOverflow字段中</span>
                    <span class="token keyword">return</span> ns<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 获取成功后, 直接返回</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">>=</span> WBIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 写锁被占用,以随机方式探测是否要退出自旋</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>LockSupport<span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token operator">--</span>spins<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            WNode nh <span class="token operator">=</span> whead<span class="token punctuation">,</span> np <span class="token operator">=</span> wtail<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nh <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> np <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> nh<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        spins <span class="token operator">=</span> SPINS<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// p == null表示队列为空, 则初始化队列(构造头结点)</span>
            WNode hd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span>WMODE<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WHEAD<span class="token punctuation">,</span> null<span class="token punctuation">,</span> hd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                wtail <span class="token operator">=</span> hd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">// 将当前线程包装成读结点</span>
            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span>RMODE<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> p <span class="token operator">||</span> p<span class="token punctuation">.</span>mode <span class="token operator">!=</span> RMODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 如果队列只有一个头结点, 或队尾结点不是读结点, 则直接将结点链接到队尾, 链接完成后退出自旋</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>prev <span class="token operator">!=</span> p<span class="token punctuation">)</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WTAIL<span class="token punctuation">,</span> p<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 队列不为空, 且队尾是读结点, 则将添加当前结点链接到队尾结点的cowait链中（实际上构成一个栈, p是栈顶指针 ）</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> WCOWAIT<span class="token punctuation">,</span> node<span class="token punctuation">.</span>cowait <span class="token operator">=</span> p<span class="token punctuation">.</span>cowait<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// CAS操作队尾结点p的cowait字段,实际上就是头插法插入结点</span>
            node<span class="token punctuation">.</span>cowait <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                WNode pp<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
                Thread w<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 尝试唤醒头结点的cowait中的第一个元素, 假如是读锁会通过循环释放cowait链</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> WCOWAIT<span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// help release</span>
                    U<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">||</span> h <span class="token operator">==</span> p <span class="token operator">||</span> pp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">&lt;</span> RFULL <span class="token operator">?</span>
                            U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span>
                                ns <span class="token operator">=</span> s <span class="token operator">+</span> RUNIT<span class="token punctuation">)</span> <span class="token operator">:</span>
                            <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> WBIT <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> 0L<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">return</span> ns<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> WBIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>prev <span class="token operator">==</span> pp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> time<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token operator">==</span> null <span class="token operator">||</span> h <span class="token operator">==</span> p <span class="token operator">||</span> p<span class="token punctuation">.</span>status <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        node <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// throw away</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> 0L<span class="token punctuation">)</span>
                        time <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> 0L<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">!=</span> pp <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">==</span> WBIT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>prev <span class="token operator">==</span> pp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 写锁被占用, 且当前结点不是队首结点, 则阻塞当前线程</span>
                        U<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WNode h<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pp<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 如果当前线程是队首结点, 则尝试获取读锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                spins <span class="token operator">=</span> HEAD_SPINS<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> MAX_HEAD_SPINS<span class="token punctuation">)</span>
                spins <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> spins<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// spin at head</span>
                <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">&lt;</span> RFULL <span class="token operator">?</span>     <span class="token comment" spellcheck="true">// 判断写锁是否被占用</span>
                    U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> RUNIT<span class="token punctuation">)</span> <span class="token operator">:</span>  <span class="token comment" spellcheck="true">//写锁未占用,且读锁数量未超限, 则更新同步状态</span>
                    <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> WBIT <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> 0L<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//写锁未占用,但读锁数量超限, 超出部分放到readerOverflow字段中</span>
                    <span class="token comment" spellcheck="true">// 获取读锁成功, 释放cowait链中的所有读结点</span>
                    WNode c<span class="token punctuation">;</span>
                    Thread w<span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// 释放头结点, 当前队首结点成为新的头结点</span>
                    whead <span class="token operator">=</span> node<span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// 从栈顶开始(node.cowait指向的结点), 依次唤醒所有读结点, 最终node.cowait==null, node成为新的头结点</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> node<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> WCOWAIT<span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                            U<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> ns<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">>=</span> WBIT <span class="token operator">&amp;&amp;</span>
                    LockSupport<span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>k <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 如果头结点存在cowait链, 则唤醒链中所有读线程</span>
            WNode c<span class="token punctuation">;</span>
            Thread w<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> WCOWAIT<span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    U<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>np <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// stale</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps <span class="token operator">=</span> p<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 将前驱结点的等待状态置为WAITING, 表示之后将唤醒当前结点</span>
                U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> WSTATUS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WAITING<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> CANCELLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pp<span class="token punctuation">;</span>
                    pp<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 阻塞当前读线程</span>
                <span class="token keyword">long</span> time<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> 0L<span class="token punctuation">)</span>
                    time <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> 0L<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//限时等待超时, 取消等待</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> h <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">==</span> WBIT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>prev <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果前驱的等待状态为WAITING, 且写锁被占用, 则阻塞当前调用线程</span>
                    U<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>
                U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们来分析下这个方法。<br>该方法会首先自旋的尝试获取读锁，获取成功后，就直接返回；否则，会将当前线程包装成一个读结点，插入到等待队列。<br>由于，目前等待队列还是空，所以ThreadB会初始化队列，然后将自身包装成一个读结点，插入队尾，然后在下面这个地方跳出自旋：<br><img src="image-20200922131952653.png" alt="(image-20200922131952653"></p>
<p>此时，等待队列的结构如下：<br><img src="image-20200922132004020.png" alt="(image-20200922132004020"></p>
<p>跳出自旋后，ThreadB会继续向下执行，进入下一个自旋，在下一个自旋中，依然会再次尝试获取读锁，如果这次再获取不到，就会将前驱的等待状态置为WAITING, 表示我（当前线程）要去睡了（阻塞），到时记得叫醒我：<br><img src="image-20200922132015033.png" alt="(image-20200922132015033"></p>
<p><img src="image-20200922132025687.png" alt="(image-20200922132025687"></p>
<p>最终, ThreadB进入阻塞状态:<br><img src="image-20200922132039412.png" alt="(image-20200922132039412"></p>
<p>最终，等待队列的结构如下：</p>
<p><img src="image-20200922132052263.png" alt="(image-20200922132052263"></p>
<h3 id="4-ThreadC调用readLock获取读锁"><a href="#4-ThreadC调用readLock获取读锁" class="headerlink" title="4. ThreadC调用readLock获取读锁"></a>4. ThreadC调用readLock获取读锁</h3><p>这个过程和ThreadB获取读锁一样，区别在于ThreadC被包装成结点加入等待队列后，是链接到ThreadB结点的栈指针中的。调用完下面这段代码后，ThreadC会链接到以Thread B为栈顶指针的栈中：<br><img src="(image-20200922135649764.png" alt="(image-20200922135649764"></p>
<p><img src="image-20200922132106088.png" alt="(image-20200922132106088"></p>
<blockquote>
<p>注意：读结点的cowait字段其实构成了一个栈，入栈的过程其实是个“头插法”插入单链表的过程。比如，再来个ThreadX读结点，则cowait链表结构为：<code>ThreadB - &gt; ThreadX -&gt; ThreadC</code>。最终唤醒读结点时，将从栈顶开始。</p>
</blockquote>
<p>然后会在下一次自旋中，阻塞当前读线程：<br><img src="image-20200922132118728.png" alt="(image-20200922132118728"></p>
<p>最终，等待队列的结构如下：<br><img src="image-20200922132136022.png" alt="(image-20200922132136022"></p>
<p>可以看到，此时ThreadC结点并没有把它的前驱的等待状态置为-1，因为ThreadC是链接到栈中的，当写锁释放的时候，会从栈底元素开始，唤醒栈中所有读结点。</p>
<h3 id="5-ThreadD调用writeLock获取写锁"><a href="#5-ThreadD调用writeLock获取写锁" class="headerlink" title="5. ThreadD调用writeLock获取写锁"></a>5. ThreadD调用writeLock获取写锁</h3><p>ThreadD调用<strong>writeLock</strong>方法获取写锁失败后（ThreadA依然占用着写锁），会调用<strong>acquireWrite</strong>方法，该方法整体逻辑和<strong>acquireRead</strong>差不多，首先自旋的尝试获取写锁，获取成功后，就直接返回；否则，会将当前线程包装成一个写结点，插入到等待队列。</p>
<p><img src="image-20200922133037585.png" alt="(image-20200922133037585"></p>
<p><em>acquireWrite源码：</em></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 尝试自旋的获取写锁, 获取不到则阻塞线程
 *
 * @param interruptible true 表示检测中断, 如果线程被中断过, 则最终返回INTERRUPTED
 * @param deadline      如果非0, 则表示限时获取
 * @return 非0表示获取成功, INTERRUPTED表示中途被中断过
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">acquireWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    WNode node <span class="token operator">=</span> null<span class="token punctuation">,</span> p<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 自旋入队操作
     * 如果没有任何锁被占用, 则立即尝试获取写锁, 获取成功则返回.
     * 如果存在锁被使用, 则将当前线程包装成独占结点, 并插入等待队列尾部
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">==</span> 0L<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 没有任何锁被占用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> WBIT<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 尝试立即获取写锁</span>
                <span class="token keyword">return</span> ns<span class="token punctuation">;</span>                                                 <span class="token comment" spellcheck="true">// 获取成功直接返回</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            spins <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> WBIT <span class="token operator">&amp;&amp;</span> wtail <span class="token operator">==</span> whead<span class="token punctuation">)</span> <span class="token operator">?</span> SPINS <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LockSupport<span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">--</span>spins<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> wtail<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 队列为空, 则初始化队列, 构造队列的头结点</span>
            WNode hd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span>WMODE<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WHEAD<span class="token punctuation">,</span> null<span class="token punctuation">,</span> hd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                wtail <span class="token operator">=</span> hd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span>               <span class="token comment" spellcheck="true">// 将当前线程包装成写结点</span>
            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span>WMODE<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>prev <span class="token operator">!=</span> p<span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WTAIL<span class="token punctuation">,</span> p<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 链接结点至队尾</span>
            p<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WNode h<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pp<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 如果当前结点是队首结点, 则立即尝试获取写锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                spins <span class="token operator">=</span> HEAD_SPINS<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> MAX_HEAD_SPINS<span class="token punctuation">)</span>
                spins <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> spins<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// spin at head</span>
                <span class="token keyword">long</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">==</span> 0L<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 写锁未被占用</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span>
                        ns <span class="token operator">=</span> s <span class="token operator">+</span> WBIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">// CAS修改State: 占用写锁</span>
                        <span class="token comment" spellcheck="true">// 将队首结点从队列移除</span>
                        whead <span class="token operator">=</span> node<span class="token punctuation">;</span>
                        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> ns<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>LockSupport<span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">--</span>k <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 唤醒头结点的栈中的所有读线程</span>
            WNode c<span class="token punctuation">;</span>
            Thread w<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> WCOWAIT<span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    U<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>np <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// stale</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps <span class="token operator">=</span> p<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 将当前结点的前驱置为WAITING, 表示当前结点会进入阻塞, 前驱将来需要唤醒我</span>
                U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> WSTATUS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WAITING<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> CANCELLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pp<span class="token punctuation">;</span>
                    pp<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 阻塞当前调用线程</span>
                <span class="token keyword">long</span> time<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 0 argument to park means no timeout</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> 0L<span class="token punctuation">)</span>
                    time <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> 0L<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> h <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> ABITS<span class="token punctuation">)</span> <span class="token operator">!=</span> 0L<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>prev <span class="token operator">==</span> p<span class="token punctuation">)</span>
                    U<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// emulate LockSupport.park</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>
                U<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>acquireWrite</strong>中的下面这个自旋操作，用于将线程包装成写结点，插入队尾：<br><img src="image-20200922133235161.png" alt="(image-20200922133235161"></p>
<p>插入完成后，队列结构如下：<br><img src="image-20200922133701747.png" alt="(image-20200922133701747"></p>
<p>然后，进入下一个自旋，并在下一个自旋中阻塞ThreadD，最终队列结构如下：<br><img src="image-20200922133730463.png" alt="(image-20200922133730463"></p>
<h3 id="6-ThreadE调用readLock获取读锁"><a href="#6-ThreadE调用readLock获取读锁" class="headerlink" title="6. ThreadE调用readLock获取读锁"></a>6. ThreadE调用readLock获取读锁</h3><p>同样，由于写锁被ThreadA占用着，所以最终会调用<strong>acquireRead</strong>方法，在该方法的第一个自旋中，会将ThreadE加入等待队列：<br><img src="image-20200922135143639.png" alt="(image-20200922135143639"></p>
<blockquote>
<p>注意，由于队尾结点是写结点，所以当前读结点会直接链接到队尾；如果队尾是读结点，则会链接到队尾读结点的cowait链中。</p>
</blockquote>
<p>然后进入第二个自旋，阻塞ThreadE，最终队列结构如下：<br><img src="image-20200922135154316.png" alt="(image-20200922135154316"></p>
<h3 id="7-ThreadA调用unlockWrite释放写锁"><a href="#7-ThreadA调用unlockWrite释放写锁" class="headerlink" title="7. ThreadA调用unlockWrite释放写锁"></a>7. ThreadA调用unlockWrite释放写锁</h3><p>通过CAS操作，修改State成功后，会调用<strong>release</strong>方法唤醒等待队列的队首结点：<br><img src="image-20200922135208152.png" alt="(image-20200922135208152"></p>
<p><strong>release</strong>方法非常简单，先将头结点的等待状态置为0，表示即将唤醒后继结点，然后立即唤醒队首结点：<br><img src="image-20200922135218433.png" alt="(image-20200922135218433"></p>
<p>此时，等待队列的结构如下：<br><img src="image-20200922135233190.png" alt="(image-20200922135233190"></p>
<h3 id="8-ThreadB被唤醒后继续向下执行"><a href="#8-ThreadB被唤醒后继续向下执行" class="headerlink" title="8. ThreadB被唤醒后继续向下执行"></a>8. ThreadB被唤醒后继续向下执行</h3><p>ThreadB被唤醒后，会从原阻塞处继续向下执行，然后开始下一次自旋：<br><img src="image-20200922135245323.png" alt="(image-20200922135245323"></p>
<p>第二次自旋时，ThreadB发现写锁未被占用，则成功获取到读锁，然后从栈顶（ThreadB的cowait指针指向的结点）开始唤醒栈中所有线程，<br>最后返回：<br><img src="image-20200922135257395.png" alt="(image-20200922135257395"></p>
<p>最终，等待队列的结构如下：<br><img src="image-20200922135310849.png" alt="(image-20200922135310849"></p>
<h3 id="9-ThreadC被唤醒后继续向下执行"><a href="#9-ThreadC被唤醒后继续向下执行" class="headerlink" title="9. ThreadC被唤醒后继续向下执行"></a>9. ThreadC被唤醒后继续向下执行</h3><p>ThreadC被唤醒后，继续执行，并进入下一次自旋，下一次自旋时，会成功获取到读锁。<br><img src="image-20200922135328579.png" alt="(image-20200922135328579"></p>
<p>注意，此时ThreadB和ThreadC已经拿到了读锁，ThreadD（写线程）和ThreadE（读线程）依然阻塞中，原来ThreadC对应的结点是个孤立结点，会被GC回收。</p>
<p>最终，等待队列的结构如下：<br><img src="image-20200922135340146.png" alt="(image-20200922135340146"></p>
<h3 id="10-ThreadB和ThreadC释放读锁"><a href="#10-ThreadB和ThreadC释放读锁" class="headerlink" title="10. ThreadB和ThreadC释放读锁"></a>10. ThreadB和ThreadC释放读锁</h3><p>ThreadB和ThreadC调用<strong>unlockRead</strong>方法释放读锁，CAS操作State将读锁数量减1：<br><img src="image-20200922135349722.png" alt="(image-20200922135349722"></p>
<p>注意，当读锁的数量变为0时才会调用<strong>release</strong>方法，唤醒队首结点：<br><img src="image-20200922135406780.png" alt="(image-20200922135406780"></p>
<p>队首结点（ThreadD写结点被唤醒），最终等待队列的结构如下：<br><img src="image-20200922135420734.png" alt="(image-20200922135420734"></p>
<h3 id="11-ThreadD被唤醒后继续向下执行"><a href="#11-ThreadD被唤醒后继续向下执行" class="headerlink" title="11. ThreadD被唤醒后继续向下执行"></a>11. ThreadD被唤醒后继续向下执行</h3><p>ThreadD会从原阻塞处继续向下执行，并在下一次自旋中获取到写锁，然后返回:<br><img src="image-20200922135440824.png" alt="(image-20200922135440824"></p>
<p>最终，等待队列的结构如下：<br><img src="image-20200922135450981.png" alt="(image-20200922135450981"></p>
<h3 id="12-ThreadD调用unlockWrite释放写锁"><a href="#12-ThreadD调用unlockWrite释放写锁" class="headerlink" title="12. ThreadD调用unlockWrite释放写锁"></a>12. ThreadD调用unlockWrite释放写锁</h3><p>ThreadD释放写锁的过程和步骤7于ThreadE是个读结点，所以同时会唤醒cowait栈中的所有读结点，过程和步骤8完全一样。最终，等待队列的结构如下：</p>
<p><img src="C:%5CUsers%5C65135%5CDesktop%5Cblog%E6%96%87%E7%AB%A0%5C%E6%B7%B1%E5%85%A5%E5%B9%B6%E5%8F%91%5Cjuc_locks%E6%A1%86%E6%9E%B6-7-AQS_StampedLock(image-20200922135459409.png" alt="(image-20200922135459409"></p>
<p><img src="image-20200922135631763.png" alt="(image-20200922135631763"></p>
<p>至此，全部执行完成。</p>
<h2 id="四、StampedLock类-方法声明"><a href="#四、StampedLock类-方法声明" class="headerlink" title="四、StampedLock类/方法声明"></a>四、StampedLock类/方法声明</h2><p>参考Oracle官方文档：<a href="https://docs.oracle.com/javase/8/docs/api/" target="_blank" rel="noopener">https://docs.oracle.com/javas…</a><br><strong><em>类声明：\</em></strong><br><img src="image-20200922135522882.png" alt="(image-20200922135522882"></p>
<p><strong><em>方法声明：\</em></strong><br><img src="image-20200922135547455.png" alt="(image-20200922135547455"></p>
<h2 id="五、StampedLock总结"><a href="#五、StampedLock总结" class="headerlink" title="五、StampedLock总结"></a>五、StampedLock总结</h2><p>StampedLock的等待队列与RRW的CLH队列相比，有以下特点：</p>
<ol>
<li>当入队一个线程时，如果队尾是读结点，不会直接链接到队尾，而是链接到该读结点的cowait链中，cowait链本质是一个栈；</li>
<li>当入队一个线程时，如果队尾是写结点，则直接链接到队尾；</li>
<li>唤醒线程的规则和AQS类似，都是首先唤醒队首结点。区别是StampedLock中，当唤醒的结点是读结点时，会唤醒该读结点的cowait链中的所有读结点（顺序和入栈顺序相反，也就是后进先出）。</li>
</ol>
<p>另外，StampedLock使用时要特别小心，避免锁重入的操作，在使用乐观读锁时也需要遵循相应的调用模板，防止出现数据不一致的问题。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%94%81/" rel="tag"># 锁</a>
              <a href="/tags/%E6%B7%B1%E5%85%A5%E5%B9%B6%E5%8F%91/" rel="tag"># 深入并发</a>
              <a href="/tags/juc/" rel="tag"># juc</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/18/old/juc_locks%E6%A1%86%E6%9E%B6-6-AQS_%E8%AF%BB%E5%86%99%E9%94%81/" rel="prev" title="juc_locks框架#6-AQS_读写锁">
      <i class="fa fa-chevron-left"></i> juc_locks框架#6-AQS_读写锁
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/20/old/juc_atomic%E6%A1%86%E6%9E%B6-1-Unsase%E7%B1%BB/" rel="next" title="juc_atomic框架#1-Unsase类">
      juc_atomic框架#1-Unsase类 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、StampedLock类简介"><span class="nav-text">一、StampedLock类简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-StampedLock的引入"><span class="nav-text">1.1 StampedLock的引入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-StampedLock的特点"><span class="nav-text">1.2 StampedLock的特点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、StampedLock使用示例"><span class="nav-text">二、StampedLock使用示例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、StampedLock原理"><span class="nav-text">三、StampedLock原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-StampedLock的内部常量"><span class="nav-text">3.1 StampedLock的内部常量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-示例分析"><span class="nav-text">3.2 示例分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-StampedLock对象的创建"><span class="nav-text">1. StampedLock对象的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ThreadA调用writeLock获取写锁"><span class="nav-text">2. ThreadA调用writeLock获取写锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ThreadB调用readLock获取读锁"><span class="nav-text">3. ThreadB调用readLock获取读锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ThreadC调用readLock获取读锁"><span class="nav-text">4. ThreadC调用readLock获取读锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-ThreadD调用writeLock获取写锁"><span class="nav-text">5. ThreadD调用writeLock获取写锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-ThreadE调用readLock获取读锁"><span class="nav-text">6. ThreadE调用readLock获取读锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-ThreadA调用unlockWrite释放写锁"><span class="nav-text">7. ThreadA调用unlockWrite释放写锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-ThreadB被唤醒后继续向下执行"><span class="nav-text">8. ThreadB被唤醒后继续向下执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-ThreadC被唤醒后继续向下执行"><span class="nav-text">9. ThreadC被唤醒后继续向下执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-ThreadB和ThreadC释放读锁"><span class="nav-text">10. ThreadB和ThreadC释放读锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-ThreadD被唤醒后继续向下执行"><span class="nav-text">11. ThreadD被唤醒后继续向下执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-ThreadD调用unlockWrite释放写锁"><span class="nav-text">12. ThreadD调用unlockWrite释放写锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、StampedLock类-方法声明"><span class="nav-text">四、StampedLock类&#x2F;方法声明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、StampedLock总结"><span class="nav-text">五、StampedLock总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="摘星"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">摘星</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">261</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">142</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhangkexuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhangkexuan" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/kexuan_zhang@qq.com" title="E-Mail → kexuan_zhang@qq.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">摘星</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/clicklove.js"></script>
