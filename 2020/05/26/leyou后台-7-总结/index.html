<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="总结整个后台管理系统后端代码的关键技术和重难点，总的来说大致步骤是：  搭建基于springcloud的微服务 罗列后台需要提供和支持的API接口 对数据库进行操作">
<meta property="og:type" content="article">
<meta property="og:title" content="leyou后台管理#7-总结">
<meta property="og:url" content="http://yoursite.com/2020/05/26/leyou%E5%90%8E%E5%8F%B0-7-%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="摘星">
<meta property="og:description" content="总结整个后台管理系统后端代码的关键技术和重难点，总的来说大致步骤是：  搭建基于springcloud的微服务 罗列后台需要提供和支持的API接口 对数据库进行操作">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-25T18:20:44.000Z">
<meta property="article:modified_time" content="2021-05-19T02:09:48.189Z">
<meta property="article:author" content="摘星">
<meta property="article:tag" content="总结">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/05/26/leyou%E5%90%8E%E5%8F%B0-7-%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>leyou后台管理#7-总结 | 摘星</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">摘星</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/leyou%E5%90%8E%E5%8F%B0-7-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="摘星">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="摘星">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          leyou后台管理#7-总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-26 02:20:44" itemprop="dateCreated datePublished" datetime="2020-05-26T02:20:44+08:00">2020-05-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leyou/" itemprop="url" rel="index"><span itemprop="name">leyou</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>总结整个后台管理系统后端代码的关键技术和重难点，总的来说大致步骤是：</p>
<ul>
<li>搭建基于springcloud的微服务</li>
<li>罗列后台需要提供和支持的API接口</li>
<li>对数据库进行操作</li>
</ul>
<span id="more"></span>

<h1 id="MICRO-SERVICE"><a href="#MICRO-SERVICE" class="headerlink" title="MICRO SERVICE"></a>MICRO SERVICE</h1><p>微服务相关会在之后再总结，这次是通过maven架构的结构，先看看父pom：</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.leyou.parent&lt;/groupId&gt;
    &lt;artifactId&gt;leyou&lt;/artifactId&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;
    &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
    &lt;modules&gt;
        &lt;module&gt;leyou-registry&lt;/module&gt;
        &lt;module&gt;leyou-gateway&lt;/module&gt;
        &lt;module&gt;leyou-item&lt;/module&gt;
        &lt;module&gt;leyou-common&lt;/module&gt;
        &lt;module&gt;leyou-upload&lt;/module&gt;
    &lt;/modules&gt;

    &lt;name&gt;leyou&lt;/name&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.3.0.RELEASE&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;Hoxton.SR4&lt;/spring-cloud.version&gt;
        &lt;mybatis.starter.version&gt;2.1.2&lt;/mybatis.starter.version&gt;
        &lt;mapper.starter.version&gt;2.1.5&lt;/mapper.starter.version&gt;
        &lt;pageHelper.starter.version&gt;1.2.13&lt;/pageHelper.starter.version&gt;
        &lt;mysql.version&gt;8.0.20&lt;/mysql.version&gt;
        &lt;fastDFS.client.version&gt;1.27.2&lt;/fastDFS.client.version&gt;
    &lt;/properties&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;!-- springCloud --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
            &lt;!-- mybatis启动器 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
                &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mybatis.starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- 通用Mapper启动器 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
                &lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mapper.starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- 分页助手启动器 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
                &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;pageHelper.starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- mysql驱动 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;mysql&lt;/groupId&gt;
                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mysql.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!--FastDFS客户端--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.tobato&lt;/groupId&gt;
                &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt;
                &lt;version&gt;$&#123;fastDFS.client.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<p>内容都一目了然,继承了父Hoxton.SR4,然后锁了版本,需要的启动器都依赖导入.</p>
<h2 id="REGISTRY"><a href="#REGISTRY" class="headerlink" title="REGISTRY"></a>REGISTRY</h2><p>直接使用的Eureka,三步走:依赖-&gt;配置-&gt;引导</p>
<h3 id="SERVER"><a href="#SERVER" class="headerlink" title="SERVER"></a>SERVER</h3><p><strong>依赖：</strong></p>
<pre><code class="xml">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<p><strong>配置：</strong></p>
<pre><code class="yaml">server:
  port: 10086
spring:
  application:
    name: leyou-registry
eureka:
  client:
    service-url:
      defaultZone: http://localhost:$&#123;server.port&#125;/eureka
    register-with-eureka: false  # 把自己注册到eureka服务列表
    fetch-registry: false  # 拉取eureka服务信息
  server:
    enable-self-preservation: true # 关闭自我保护
    eviction-interval-timer-in-ms: 5000000 # 每隔5000秒钟，进行一次服务列表的清理
</code></pre>
<p>注册里设置不将server注册到eureka服务中，是为了防止服务还没打开就自己注册自己。其实自己注册自己在单个server时用处不大，在sercer集群时候考虑循环注入就可。</p>
<p>自我保护是触发了Eureka的自我保护机制。当一个服务未按时进行心跳续约时，Eureka会统计最近15分钟心跳失败的服务实例的比例是否超过了85%。在生产环境下，因为网络延迟等原因，心跳失败实例的比例很有可能超标，但是此时就把服务剔除列表并不妥当，因为服务可能没有宕机。Eureka就会把当前实例的注册信息保护起来，不予剔除。生产环境下这很有效，保证了大多数服务依然可用。但是这给我们的开发带来了麻烦， 因此开发阶段我们都会关闭自我保护模式。</p>
<p>失效剔除就失去心跳的自动剔除。</p>
<p><strong>引导：</strong></p>
<pre><code class="java">package com.leyou;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class ResgistryApplication &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(ResgistryApplication.class,args);
    &#125;
&#125;
</code></pre>
<h3 id="CLIENT"><a href="#CLIENT" class="headerlink" title="CLIENT"></a>CLIENT</h3><p><strong>依赖:</strong></p>
<pre><code class="xml">        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p><strong>配置:</strong></p>
<pre><code class="yaml">server:
  port: 10010
spring:
  application:
    name: xxx
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka
    registry-fetch-interval-seconds: 5
</code></pre>
<p><strong>引导:</strong></p>
<pre><code class="java">package com.leyou;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class xxxApplication &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(ResgistryApplication.class,args);
    &#125;
&#125;
</code></pre>
<h2 id="GATEWAY"><a href="#GATEWAY" class="headerlink" title="GATEWAY"></a>GATEWAY</h2><p>使用的是ZUUL,三步走:依赖-&gt;配置-&gt;引导</p>
<p><strong>依赖:</strong></p>
<pre><code class="xml">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- springboot提供微服务检测接口，默认对外提供几个接口 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<p>需要注意的是spring-boot-starter-actuator,这提供了一个默认对外接口,可以直接访问<a target="_blank" rel="noopener" href="http://192.168.0.102:10010/actuator/info%E6%9D%A5%E9%AA%8C%E8%AF%81%E8%AF%A5%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%90%A6%E7%9C%9F%E7%9A%84%E5%90%AF%E5%8A%A8%E8%B5%B7%E6%9D%A5%E4%BA%86">http://192.168.0.102:10010/actuator/info来验证该服务是否真的启动起来了</a>.</p>
<p><strong>配置:</strong></p>
<pre><code class="yaml">server:
  port: 10010
spring:
  application:
    name: leyou-gateway
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka
    registry-fetch-interval-seconds: 5
zuul:
  prefix: /api
  routes:
    item-service: /item/** # 商品微服务的映射路径,路由到商品
</code></pre>
<p>这里的网关配置:先注册到了eureka中,在直接配置了路由,指向item-service的路由.</p>
<p><strong>引导:</strong></p>
<pre><code class="java">package com.leyou;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableDiscoveryClient
@EnableZuulProxy
public class GatewayApplication &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(GatewayApplication.class,args);
    &#125;
&#125;
</code></pre>
<p>引导了自动配置、EUREKA的注册、ZUUL的代理</p>
<h2 id="ITEM"><a href="#ITEM" class="headerlink" title="ITEM"></a>ITEM</h2><p>这是业务的主体，没有mapper的原因是使用了通用mapper，对数据库的配置直接放到ITEM中。</p>
<p><strong>依赖：</strong></p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;!-- web启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- eureka客户端 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- mybatis的启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
        &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 通用mapper启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
        &lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 分页助手启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
        &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- jdbc启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- mysql驱动 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;mysql&lt;/groupId&gt;
        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.leyou.item&lt;/groupId&gt;
        &lt;artifactId&gt;leyou-item-interface&lt;/artifactId&gt;
        &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- springboot检测服务启动器 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.leyou.common&lt;/groupId&gt;
        &lt;artifactId&gt;leyou-common&lt;/artifactId&gt;
        &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p><strong>配置：</strong></p>
<pre><code class="properties">server.port=8081
spring.application.name=item-service
spring.datasource.url=jdbc:mysql://localhost:3306/leyou?serverTimezone=UTC&amp;useSSL=true
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.hikari.max-lifetime=28830000
# 一个连接的生命时长（毫秒），超时而且没被使用则被释放（retired），缺省:30分钟，建议设置比数据库超时时长少30秒，参考MySQL wait_timeout参数（show variables like &#39;%timeout%&#39;;）
spring.datasource.hikari.maximum-pool-size=9
# 连接池中允许的最大连接数。缺省值：10；推荐的公式：((core_count * 2) + effective_spindle_count)
eureka.client.service-url.defaultZone=http://127.0.0.1:10086/eureka
eureka.instance.lease-renewal-interval-in-seconds=5
# 5秒钟发送一次心跳
eureka.instance.lease-expiration-duration-in-seconds=10
# 10秒不发送就过期
mybatis.type-aliases-package=com.leyou.item.pojo
</code></pre>
<p>这里配置我试过几次，使用yaml就连不上数据库，只有使用properties才能连接。</p>
<p><strong>引导：</strong></p>
<pre><code class="java">package com.leyou;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@EnableDiscoveryClient
@MapperScan(&quot;com.leyou.item.mapper&quot;)
public class ItemServiceApplication &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(ItemServiceApplication.class, args);
    &#125;
&#125;
</code></pre>
<p>引导了自动配置、服务发现、mapper扫描-&gt;针对通用mapper</p>
<h1 id="CONTROLLER"><a href="#CONTROLLER" class="headerlink" title="CONTROLLER"></a>CONTROLLER</h1><p>通过网关后，就直接到了服务器中的controller。从页面传来的数据主要是GET/POST/PUT/DELETE/OPTIONS，下分别分类处理</p>
<h2 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h2><p>GET很直接，直接上真实的处理,两种处理方式.</p>
<pre><code class="java">    @GetMapping(&quot;page&quot;)
    public ResponseEntity&lt;PageResult&lt;Brand&gt;&gt; queryBrandsByPage(
            @RequestParam(value = &quot;key&quot;,required = false)String key,
            @RequestParam(value = &quot;page&quot;,defaultValue = &quot;1&quot;)Integer page,
            @RequestParam(value = &quot;rows&quot;,defaultValue = &quot;5&quot;)Integer rows,
            @RequestParam(value = &quot;sortBy&quot;,defaultValue = &quot;id&quot;)String sortBy,
            @RequestParam(value = &quot;desc&quot;,defaultValue = &quot;asc&quot;)Boolean desc
    )&#123;
        PageResult&lt;Brand&gt; result = this.brandService.queryBrandsByPage(key,page,rows,sortBy,desc);
        if (result==null)
        &#123;
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(null);
        &#125;
        return ResponseEntity.ok(result);
    &#125;
</code></pre>
<pre><code class="java">    @GetMapping(&quot;cid/&#123;cid&#125;&quot;)
    public ResponseEntity&lt;List&lt;Brand&gt;&gt; queryBrandsByCid(@PathVariable(&quot;cid&quot;)Long cid)&#123;
        List&lt;Brand&gt; brands = this.brandService.queryBrandsByCid(cid);
        if (CollectionUtils.isEmpty(brands)) &#123;
            return ResponseEntity.notFound().build();
        &#125;
        return ResponseEntity.ok(brands);
    &#125;
</code></pre>
<ul>
<li>收值</li>
</ul>
<p>直接使用<code>@PathVariable(&quot;cid&quot;)Long cid</code>接受页面的单值;</p>
<p>使用<code> @RequestParam(value = &quot;key&quot;,required = false)String key</code>接收k-v值,接收时,可以处理是否必须?是否默认值?</p>
<ul>
<li>回值</li>
</ul>
<p>用于RestTemplate方法，<code>ResponseEntity.status(HttpStatus.NOT_FOUND).build()</code>向页面返回值</p>
<ul>
<li>传值</li>
</ul>
<p>在调用service时,直接将接收传到service去,让service处理一切</p>
<h2 id="POST、PUT"><a href="#POST、PUT" class="headerlink" title="POST、PUT"></a>POST、PUT</h2><pre><code class="JAVA"> @PostMapping
    public ResponseEntity&lt;Void&gt; saveBrand(Brand brand,@RequestParam(&quot;cids&quot;) List&lt;Long&gt; cids )&#123;
        this.brandService.saveBrand(brand,cids);
        return ResponseEntity.status(HttpStatus.CREATED).build();
    &#125;
</code></pre>
<pre><code class="java">@PutMapping(&quot;goods&quot;)
public ResponseEntity&lt;Void&gt; updateGoods(@RequestBody SpuBo spuBo)&#123;
    this.goodsService.updateGoods(spuBo);
    return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
&#125;
</code></pre>
<p>POST、PUT的处理就很类似，先说post：</p>
<ol>
<li>发送post的路径就是所在controller的根路径</li>
<li>post前端发送的是一个form表单，后台接受的时候，直接用一个pojo来接收，那么controller会根据key名，自动注入到pojo中</li>
<li>from传来的字段比pojo字段要多一个cids，此时我们可以用<code>@RequestParam(&quot;cids&quot;) List&lt;Long&gt; cids</code>来接收</li>
<li>业务处理全转给service来做</li>
</ol>
<p>再说put:</p>
<ol>
<li>put其实和post差不多,但这次的前端发送的是json,所以我们需要使用<code>(@RequestBody SpuBo spuBo)</code>来接收</li>
<li>这里的controller也会直接将json按照k字注入到pojo里</li>
<li>业务处理全转给service来做</li>
</ol>
<h2 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h2><p>预检请求,会在设置cors时候再说</p>
<h1 id="SERVICE"><a href="#SERVICE" class="headerlink" title="SERVICE"></a>SERVICE</h1><p>MAPPER中直接使用了通用mapper,实际上这里该用mybatis来练习操作数据库.通用MAPPER已经将操作封装好了,我们只需要在service中调用就行了.</p>
<p>我们先理一下SERVICE逻辑:</p>
<h2 id="BRANDS"><a href="#BRANDS" class="headerlink" title="BRANDS"></a>BRANDS</h2><pre><code class="JAVA">    /**
     * 根据查询条件分页查询品牌信息
     * 1-&gt;查询语句-&gt;selectByExample
     *     1/1-&gt;设置条件 criteria.andLike.orEqualTo
     *                  example.setOrderByClause
     *     1/2-&gt;设置分页 PageHelper.startPage(page, rows)
     * 2-&gt;包装PageInfo
     * 3-&gt;返回PageResult
     */
public PageResult&lt;Brand&gt; queryBrandsByPage(String key, Integer page, Integer rows, String sortBy, Boolean desc) &#123;
    // 初始化example对象
    Example example = new Example(Brand.class);
    Example.Criteria criteria = example.createCriteria();

    // 根据name模糊查询，或者根据首字母查询
    if (StringUtils.isNotBlank(key)) &#123;
        criteria.andLike(&quot;name&quot;, &quot;%&quot; + key + &quot;%&quot;).orEqualTo(&quot;letter&quot;, key);
    &#125;

    // 添加分页条件
    PageHelper.startPage(page, rows);

    // 添加排序条件
    if (StringUtils.isNotBlank(sortBy)) &#123;
        example.setOrderByClause(sortBy + &quot; &quot; + (desc ? &quot;desc&quot; : &quot;asc&quot;));
    &#125;

    List&lt;Brand&gt; brands = this.brandMapper.selectByExample(example);
    // 包装成pageInfo
    PageInfo&lt;Brand&gt; pageInfo = new PageInfo&lt;&gt;(brands);
    // 包装成分页结果集返回
    return new PageResult&lt;&gt;(pageInfo.getTotal(), pageInfo.getList());
&#125;
</code></pre>
<p>重点在分页的使用,以及example和criteria的使用</p>
<pre><code class="java">    /**
     * 品牌的添加
     * 1-&gt;brand表-&gt;insertSelective
     * 2-&gt;中间表-&gt;自定义
     */
    public void saveBrand(Brand brand, List&lt;Long&gt; cids) &#123;
        //添加brand
        this.brandMapper.insertSelective(brand);
        //添加中间表
        cids.forEach(cid-&gt;&#123;
            this.brandMapper.insertCategoryAndBrand(cid,brand.getId());
        &#125;);
    &#125;
</code></pre>
<p>这里的insert选择的是insertselective,以为insertselective更加精简,会随着具体情况而适配哪些values,但insert会列出全部的values,多余的赋null.</p>
<p>cids数组需要遍历后逐一操作,这是java8的新特性forEach.</p>
<pre><code class="java">    /**
     * 根据cid查询品牌列表
     * -&gt;cid是主键,直接selectByPrimaryKey
     */
    public List&lt;Brand&gt; queryBrandsByCid(Long cid) &#123;
        return this.brandMapper.selectBrandsByCid(cid);
    &#125;

    public Brand queryBrandByBid(Long bid) &#123;
        Brand brand = this.brandMapper.selectByPrimaryKey(bid);
        return brand;
    &#125;
</code></pre>
<p>直接根据主键查询即可</p>
<pre><code class="java">/**
 * 更新brand-&gt;先删后存
 * 1-&gt;删除旧的brand
 * 2-&gt;删除旧的中间表
 * 3-&gt;直接转发给saveBrand
 */
public void updateBrand(Brand brand, List&lt;Long&gt; cids) &#123;
    //删除旧的brand
    this.brandMapper.deleteByPrimaryKey(brand.getId());
    //清除旧的中间表
    cids.forEach(
            cid-&gt;&#123;
                this.stockMapper.deleteByPrimaryKey(cid);
            &#125;
    );
    //转发到add
    this.saveBrand(brand,cids);
&#125;
</code></pre>
<p>直接在原基础上修改的话,涉及到有些多对多关系需要删除,其实还不如直接全删,再添加.当然也可以直接修改,逻辑上会复杂很多.</p>
<h2 id="CATEGORY"><a href="#CATEGORY" class="headerlink" title="CATEGORY"></a>CATEGORY</h2><pre><code class="JAVA">/**
 * 根据父节点查询子节点
 * -&gt;select-&gt;需要record-&gt;record是一个&lt;T&gt;类,填入部分需求,可返回List
 */
public List&lt;Category&gt; queryCategoriesByPid(Long pid) &#123;
    Category record = new Category();
    record.setParentId(pid);
    return this.categoryMapper.select(record);
&#125;
</code></pre>
<p>select需要一个&lt;T&gt;型类型,按照set的条件,返回所有符合的List</p>
<pre><code class="java">    /**
     * id集查询品类集
     * 1-&gt;查询所有-&gt;selectByExample-&gt;criteria.andIn(&quot;id&quot;,ids)
     * 2-&gt;集合转化-&gt;stream().map(       ).collect(Collectors.toList())
     * @param ids
     * @return
     */
    public List&lt;String&gt; queryNamesByIds(List&lt;Long&gt;ids)&#123;
        Example example = new Example(Category.class);
        Example.Criteria criteria = example.createCriteria();
        criteria.andIn(&quot;id&quot;,ids);
        List&lt;Category&gt; categories = this.categoryMapper.selectByExample(example);
        return categories.stream().map(
                //category -&gt; category.getName()
                Category::getName
        ).collect(Collectors.toList());
    &#125;
&#125;
</code></pre>
<p>selectByExample的使用以及stream的使用.这里返回给controller的是string集合可通过</p>
<pre><code>List&lt;String&gt; names = this.categoryService.queryNamesByIds(Arrays.asList(spu.getCid1(), spu.getCid2(), spu.getCid3()));
spuBo.setCname(StringUtils.join(names,&quot;/&quot;));
</code></pre>
<p>处理成string。</p>
<h2 id="SPECIFICATION"><a href="#SPECIFICATION" class="headerlink" title="SPECIFICATION"></a>SPECIFICATION</h2><pre><code class="JAVA">/**
 * 根据分类id查询参数组
 */
public List&lt;SpecGroup&gt; queryGroupsByCid(Long cid) &#123;
    SpecGroup record = new SpecGroup();
    record.setCid(cid);
    return this.specGroupMapper.select(record);
&#125;
</code></pre>
<pre><code class="java">/**
 * 根据条件查询规格参数
 */
public List&lt;SpecParam&gt; queryParams(Long gid, Long cid, Boolean generic, Boolean searching) &#123;
    SpecParam param = new SpecParam();
    param.setGroupId(gid);
    param.setCid(cid);
    param.setGeneric(generic);
    param.setSearching(searching);
    return this.specParamMapper.select(param);
&#125;
</code></pre>
<h2 id="GOODS"><a href="#GOODS" class="headerlink" title="GOODS"></a>GOODS</h2><pre><code class="java">/**
 * 根据分页查询spu
 * 1-&gt;分页查询-&gt;selectExample+PageHelper
 * 2-&gt;查完后转换到spubo-&gt;使用stream().map( spu-&gt;&#123;&#125; ).collect(Collectors.toList())
 * 3-&gt;封装PageInfo
 */
public PageResult&lt;SpuBo&gt; querySpuByPage(String key, Boolean saleable, Integer page, Integer rows) &#123;
    //添加查询条件
    Example example = new Example(Spu.class);
    Example.Criteria criteria = example.createCriteria();
    //添加saleable过滤
    if (StringUtils.isNotBlank(key)) &#123;
        criteria.andLike(&quot;title&quot;,&quot;%&quot;+key+&quot;%&quot;);
    &#125;
    if(saleable!=null)&#123;
        criteria.andEqualTo(&quot;saleable&quot;,saleable);
    &#125;
    //添加分页
    PageHelper.startPage(page,rows);
    //查询spu集合
    List&lt;Spu&gt; spus = this.spuMapper.selectByExample(example);
    //转化为spuBo
    List&lt;SpuBo&gt; spuBos = spus.stream().map(
            spu -&gt; &#123;
                SpuBo spuBo = new SpuBo();
                BeanUtils.copyProperties(spu, spuBo);

                //查品牌名称
                Brand brand = this.brandMapper.selectByPrimaryKey(spu.getBrandId());
                spuBo.setBname(brand.getName());
                //查分类名称
                List&lt;String&gt; names = this.categoryService.queryNamesByIds(Arrays.asList(spu.getCid1(), spu.getCid2(), spu.getCid3()));
                spuBo.setCname(StringUtils.join(names,&quot;/&quot;));

                return spuBo;
            &#125;
    ).collect(Collectors.toList());
    //返回pageResult
    PageInfo&lt;Spu&gt; pageInfo = new PageInfo&lt;&gt;(spus);
    return new PageResult&lt;SpuBo&gt;(pageInfo.getTotal(),spuBos);
&#125;
</code></pre>
<p>尤其注意分页的PageHelper一定在查询前面；criteria是查询语句的通过.and来链接，而example是对查询结果进行sortBy；注意返回的PageResult</p>
<pre><code class="java">public void saveGoods(SpuBo spuBo) &#123;
    //查看接受
    System.out.println(spuBo);
    // 新增spu
    // 设置默认字段
    spuBo.setId(null);
    spuBo.setSaleable(true);
    spuBo.setValid(true);
    spuBo.setCreateTime(new Date());
    spuBo.setLastUpdateTime(spuBo.getCreateTime());

    this.spuMapper.insertSelective(spuBo);

    //新增spuDetail
    SpuDetail spuDetail = spuBo.getSpuDetail();
    spuDetail.setSpuId(spuBo.getId());
    this.spuDetailMapper.insertSelective(spuDetail);

    spuBo.getSkus().forEach(
            sku -&gt; &#123;
                sku.setSpuId(spuBo.getId());
                sku.setCreateTime(new Date());
                sku.setLastUpdateTime(sku.getCreateTime());
                this.skuMapper.insertSelective(sku);

                Stock stock = new Stock();
                stock.setSkuId(sku.getId());
                stock.setStock(sku.getStock());
                this.stockMapper.insertSelective(stock);
            &#125;
    );
&#125;
</code></pre>
<p>这又用到了新属性LIST&lt;&gt;.forEach()</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%80%BB%E7%BB%93/" rel="tag"># 总结</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/25/leyou%E5%90%8E%E5%8F%B0-6-%E5%95%86%E5%93%81%E6%93%8D%E4%BD%9C/" rel="prev" title="leyou后台管理#6-商品操作">
      <i class="fa fa-chevron-left"></i> leyou后台管理#6-商品操作
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/27/FastDFS%E6%B7%B1%E5%85%A5/" rel="next" title="FastDFS深入">
      FastDFS深入 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MICRO-SERVICE"><span class="nav-text">MICRO SERVICE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#REGISTRY"><span class="nav-text">REGISTRY</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SERVER"><span class="nav-text">SERVER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CLIENT"><span class="nav-text">CLIENT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GATEWAY"><span class="nav-text">GATEWAY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ITEM"><span class="nav-text">ITEM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CONTROLLER"><span class="nav-text">CONTROLLER</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GET"><span class="nav-text">GET</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POST%E3%80%81PUT"><span class="nav-text">POST、PUT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OPTIONS"><span class="nav-text">OPTIONS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SERVICE"><span class="nav-text">SERVICE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BRANDS"><span class="nav-text">BRANDS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CATEGORY"><span class="nav-text">CATEGORY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPECIFICATION"><span class="nav-text">SPECIFICATION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GOODS"><span class="nav-text">GOODS</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="摘星"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">摘星</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">241</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">139</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhangkexuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhangkexuan" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/kexuan_zhang@qq.com" title="E-Mail → kexuan_zhang@qq.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">摘星</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/clicklove.js"></script>
